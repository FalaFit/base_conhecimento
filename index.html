v<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://planejamentocomercialtvx.app.n8n.cloud;">
    <title>Sistema de Políticas Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .animate-shake {
            animation: shake 0.5s;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen">
    <div id="app"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script>
        const { useState, useEffect, createElement: h } = React;

        // CONFIGURAÇÕES
        const AUTH_CONFIG = {
            username: 'admin',
            password: 'mvpmvp',
            WEBHOOK_URL: 'https://planejamentocomercialtvx.app.n8n.cloud/webhook/9d54034b-156c-473a-8a81-5cd73cc2b63d',
            SESSION_TIMEOUT: 2 * 60 * 60 * 1000
        };

        // Componente de Login
        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [shake, setShake] = useState(false);

            const handleLogin = (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                setTimeout(() => {
                    if (username === AUTH_CONFIG.username && password === AUTH_CONFIG.password) {
                        const loginData = {
                            authenticated: true,
                            timestamp: Date.now(),
                            expiresAt: Date.now() + AUTH_CONFIG.SESSION_TIMEOUT
                        };
                        localStorage.setItem('authData', JSON.stringify(loginData));
                        onLogin();
                    } else {
                        setError('Usuário ou senha incorretos');
                        setShake(true);
                        setTimeout(() => setShake(false), 500);
                    }
                    setLoading(false);
                }, 800);
            };

            return h('div', { className: 'min-h-screen flex items-center justify-center px-4' },
                h('div', { className: 'absolute inset-0 overflow-hidden pointer-events-none' },
                    h('div', { className: 'absolute top-1/4 left-1/4 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl' }),
                    h('div', { className: 'absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl' })
                ),
                h('div', { className: 'w-full max-w-md relative animate-fade-in' },
                    h('div', { className: 'text-center mb-8' },
                        h('div', { className: 'inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-2xl pulse-glow mb-6' },
                            h('svg', { className: 'w-10 h-10 text-white', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z' })
                            )
                        ),
                        h('h1', { className: 'text-3xl font-bold text-white mb-2' }, 'Sistema de Políticas'),
                        h('p', { className: 'text-slate-400' }, 'Acesso seguro ao sistema de consultas')
                    ),
                    h('div', { className: `bg-slate-800/50 backdrop-blur-xl rounded-2xl border border-slate-700 shadow-2xl overflow-hidden ${shake ? 'animate-shake' : ''}` },
                        h('div', { className: 'p-8' },
                            h('form', { onSubmit: handleLogin, className: 'space-y-6' },
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium text-slate-300 mb-2' }, 'Usuário'),
                                    h('div', { className: 'relative' },
                                        h('div', { className: 'absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none' },
                                            h('svg', { className: 'h-5 w-5 text-slate-500', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' })
                                            )
                                        ),
                                        h('input', {
                                            type: 'text',
                                            value: username,
                                            onChange: (e) => setUsername(e.target.value),
                                            className: 'w-full bg-slate-900/50 text-white placeholder-slate-500 rounded-xl border border-slate-600 pl-10 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all',
                                            placeholder: 'Digite seu usuário',
                                            required: true,
                                            disabled: loading
                                        })
                                    )
                                ),
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium text-slate-300 mb-2' }, 'Senha'),
                                    h('div', { className: 'relative' },
                                        h('div', { className: 'absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none' },
                                            h('svg', { className: 'h-5 w-5 text-slate-500', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z' })
                                            )
                                        ),
                                        h('input', {
                                            type: 'password',
                                            value: password,
                                            onChange: (e) => setPassword(e.target.value),
                                            className: 'w-full bg-slate-900/50 text-white placeholder-slate-500 rounded-xl border border-slate-600 pl-10 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all',
                                            placeholder: 'Digite sua senha',
                                            required: true,
                                            disabled: loading
                                        })
                                    )
                                ),
                                error && h('div', { className: 'bg-red-500/10 border border-red-500/50 rounded-xl p-3 flex items-center gap-2 animate-fade-in' },
                                    h('svg', { className: 'w-5 h-5 text-red-400 flex-shrink-0', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' })
                                    ),
                                    h('p', { className: 'text-sm text-red-300' }, error)
                                ),
                                h('button', {
                                    type: 'submit',
                                    disabled: loading,
                                    className: 'w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 disabled:from-slate-700 disabled:to-slate-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 shadow-lg hover:shadow-blue-500/50 disabled:cursor-not-allowed flex items-center justify-center gap-2'
                                },
                                    loading ? 'Autenticando...' : 'Entrar no Sistema'
                                )
                            )
                        ),
                        h('div', { className: 'bg-slate-900/30 px-8 py-4 border-t border-slate-700' },
                            h('p', { className: 'text-xs text-slate-500 text-center' }, '🔒 Sessão expira em 2 horas de inatividade')
                        )
                    )
                )
            );
        }

        // Componente Principal
        function MainApp({ onLogout }) {
            const [pergunta, setPergunta] = useState('');
            const [loading, setLoading] = useState(false);
            const [resposta, setResposta] = useState(null);
            const [error, setError] = useState(null);
            const [historico, setHistorico] = useState([]);

            const fazerPergunta = async () => {
                if (!pergunta.trim()) return;

                setLoading(true);
                setError(null);
                setResposta(null);

                try {
                    console.log('🚀 Enviando para:', AUTH_CONFIG.WEBHOOK_URL);
                    
                    const response = await fetch(AUTH_CONFIG.WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ pergunta: pergunta.trim() })
                    });

                    console.log('📡 Status:', response.status);

                    if (!response.ok) {
                        throw new Error(`Erro HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('✅ Dados:', data);

                    let respostaFormatada;
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        respostaFormatada = {
                            resposta: data.choices[0].message.content,
                            modelo: data.model || 'gpt-4o',
                            timestamp: new Date().toISOString()
                        };
                    } else if (data.resposta || typeof data === 'string') {
                        respostaFormatada = {
                            resposta: data.resposta || data,
                            timestamp: new Date().toISOString()
                        };
                    } else {
                        respostaFormatada = {
                            resposta: JSON.stringify(data, null, 2),
                            timestamp: new Date().toISOString()
                        };
                    }
                    
                    setResposta(respostaFormatada);
                    setHistorico(prev => [{
                        pergunta: pergunta.trim(),
                        resposta: respostaFormatada,
                        timestamp: new Date().toISOString()
                    }, ...prev]);
                    
                    setPergunta('');
                    
                } catch (err) {
                    console.error('❌ Erro:', err);
                    setError(`Erro: ${err.message}. Verifique se o workflow está ativo e o CORS configurado.`);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('authData');
                onLogout();
            };

            return h('div', { className: 'min-h-screen animate-fade-in' },
                h('div', { className: 'bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 sticky top-0 z-10' },
                    h('div', { className: 'max-w-6xl mx-auto px-6 py-4 flex items-center justify-between' },
                        h('div', { className: 'flex items-center gap-3' },
                            h('div', { className: 'w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center' },
                                h('svg', { className: 'w-6 h-6 text-white', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                    h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' })
                                )
                            ),
                            h('div', null,
                                h('h1', { className: 'text-xl font-bold text-white' }, 'Sistema de Políticas Inteligente'),
                                h('p', { className: 'text-sm text-slate-400' }, 'Consulte políticas com IA')
                            )
                        ),
                        h('button', {
                            onClick: handleLogout,
                            className: 'px-4 py-2 bg-slate-700/50 hover:bg-slate-700 text-slate-300 rounded-lg transition-colors text-sm'
                        }, 'Sair')
                    )
                ),
                h('div', { className: 'max-w-6xl mx-auto px-6 py-8' },
                    h('div', { className: 'bg-slate-800/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6 mb-6 shadow-2xl' },
                        h('label', { className: 'block text-sm font-medium text-slate-300 mb-3' }, 'Faça sua pergunta sobre as políticas:'),
                        h('div', { className: 'flex gap-3' },
                            h('textarea', {
                                value: pergunta,
                                onChange: (e) => setPergunta(e.target.value),
                                placeholder: 'Ex: Qual a política sobre trabalho remoto?',
                                className: 'flex-1 bg-slate-900/50 text-white placeholder-slate-500 rounded-xl border border-slate-600 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none',
                                rows: 3,
                                disabled: loading
                            }),
                            h('button', {
                                onClick: fazerPergunta,
                                disabled: loading || !pergunta.trim(),
                                className: 'bg-blue-500 hover:bg-blue-600 disabled:bg-slate-700 text-white px-6 rounded-xl transition-all font-medium'
                            }, loading ? 'Consultando...' : 'Consultar')
                        )
                    ),
                    error && h('div', { className: 'bg-red-500/10 border border-red-500/50 rounded-xl p-4 mb-6' },
                        h('p', { className: 'text-red-300' }, error)
                    ),
                    loading && h('div', { className: 'bg-slate-800/50 rounded-2xl border border-slate-700 p-8 text-center' },
                        h('p', { className: 'text-slate-300' }, 'Analisando documentos...')
                    ),
                    resposta && h('div', { className: 'bg-slate-800/50 rounded-2xl border border-slate-700 overflow-hidden' },
                        h('div', { className: 'bg-green-500/10 border-b border-slate-700 px-6 py-3' },
                            h('span', { className: 'text-green-300 font-medium' }, '✅ Resposta encontrada')
                        ),
                        h('div', { className: 'p-6' },
                            h('div', { className: 'text-slate-100 leading-relaxed whitespace-pre-wrap' }, resposta.resposta)
                        )
                    )
                )
            );
        }

        // App Principal
        function App() {
            const [authenticated, setAuthenticated] = useState(false);

            useEffect(() => {
                const authDataStr = localStorage.getItem('authData');
                
                if (authDataStr) {
                    try {
                        const authData = JSON.parse(authDataStr);
                        const now = Date.now();
                        
                        if (authData.expiresAt && now > authData.expiresAt) {
                            localStorage.removeItem('authData');
                            setAuthenticated(false);
                        } else {
                            setAuthenticated(authData.authenticated === true);
                        }
                    } catch (e) {
                        localStorage.removeItem('authData');
                        setAuthenticated(false);
                    }
                }
            }, []);

            if (!authenticated) {
                return h(LoginScreen, { onLogin: () => setAuthenticated(true) });
            }

            return h(MainApp, { onLogout: () => setAuthenticated(false) });
        }

        // Renderiza
        ReactDOM.render(h(App), document.getElementById('app'));
    </script>
</body>
</html>
